---
import type { CollectionEntry } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import Layout from "./Layout.astro";
import { SITE } from "@config";
import { Icon } from "astro-icon/components";

export interface Props {
    post: CollectionEntry<"post">;
}

const { post } = Astro.props;

const { title, description, pubDate, updatedDate, heroImage, tags, projectMetadata, heroType } = post.data;

const ogUrl = new URL(
    heroImage ? heroImage : `${encodeURIComponent(post.slug)}.png`,
    Astro.url.origin
).href;

const { Content } = await post.render();

// Extract table of contents from the content
const tocRegex = /## Table of contents\n([\s\S]*?)(?=##|$)/;
const tocMatch = post.body.match(tocRegex);
const tableOfContents = tocMatch ? tocMatch[1].trim() : null;

// Extract headings from the content
const headingsRegex = /^##\s+(.+)$/gm;
const headings = [...post.body.matchAll(headingsRegex)].map(match => match[1]);

---

<Layout
    title={`${title} - ${SITE.title}`}
    description={description}
    image={ogUrl}
>
    <article class="w-full">
        <!-- Header Section (Matches BlogPostRedesigned) -->
        <div class="max-w-4xl mx-auto px-4 pt-16 pb-16 text-center">
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                {tags && tags.map((tag) => (
                    <a
                        href={`/tags/${tag.toLowerCase()}`}
                        class={`text-lg text-secondary-600 dark:text-secondary-200 pr-2 flex flex-wrap items-center relative underline hover:text-secondary-900 dark:hover:text-white decoration-secondary-200
                        decoration-2 transition-all duration-300 hover:-translate-y-0.5 focus-visible:p-1`}
                    >
                        <Icon name="tabler:hash" class="w-5 h-5 text-mint-icon" />
                        &nbsp;<span>{tag.toLowerCase()}</span>
                    </a>
                ))}
            </div>
            
            <h1 class="text-3xl md:text-4xl text-text dark:text-cream leading-tight tracking-tighter mb-6 font-body">
                {title}
            </h1>

            <div class="flex items-center justify-center gap-4 text-secondary-500 dark:text-secondary-400 font-sans text-sm">
                <div class="flex items-center gap-2">
                    <span>By {SITE.author}</span>
                </div>
                <span>•</span>
                <FormattedDate date={pubDate} />
                {updatedDate && (
                    <>
                        <span>•</span>
                        <span>Updated <FormattedDate date={updatedDate} /></span>
                    </>
                )}
            </div>
        </div>

        <!-- Hero Section -->
        <div class="max-w-screen-xl mx-auto px-4 pb-12">
            <div class="w-full h-[60vh] relative bg-black overflow-hidden rounded-3xl">
                {heroType === 'boids' && (
                    <boids-canvas
                        background-color="#FFF"
                        light-color="#FFFCEC"
                        fog-color="#FFF"
                        boid-color="#40e0d0"
                        highlight="#ffc0cb"
                        count="200"
                        use-orbit-controls="true"
                        duration="30"
                        forces='{"separation": 0.9, "cohesion": 0.85, "alignment": 0.2, "goal": 0.3}'
                        orientation-slerp="0.2"
                        class="w-full h-full block"
                    />
                )}
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="max-w-screen-xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-12 relative pb-12">
            
            <!-- Left Sidebar (Metadata & TOC) -->
            <div class="hidden lg:block lg:col-span-3">
                <div class="sticky top-24 space-y-8">
                    <!-- Project Metadata -->
                    {projectMetadata && (
                        <div class="space-y-6">
                            {/* {projectMetadata.techStack && (
                                <div>
                                    <h3 class="text-xs font-bold text-secondary-400 uppercase tracking-wider mb-3">Tech Stack</h3>
                                    <div class="flex flex-wrap gap-2">
                                        {projectMetadata.techStack.map(tech => (
                                            <div class={`text-sm text-secondary-600 dark:text-secondary-200 pr-2 flex flex-wrap items-center relative underline hover:text-secondary-900 dark:hover:text-white decoration-secondary-200
                                            decoration-2 transition-all duration-300 hover:-translate-y-0.5 focus-visible:p-1 cursor-default`}>
                                                <Icon name="tabler:hash" class="w-4 h-4 text-mint-icon" />
                                                &nbsp;<span>{tech}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )} */}
                            
                            {(projectMetadata.githubLink || projectMetadata.liveLink) && (
                                <div>
                                    <h3 class="text-xs font-bold text-secondary-400 uppercase tracking-wider mb-3">Links</h3>
                                    <div class="flex flex-col gap-2">
                                        {projectMetadata.liveLink && (
                                            <a href={projectMetadata.liveLink} target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-secondary-600 hover:text-secondary-900 dark:text-secondary-400 dark:hover:text-secondary-100 flex items-center gap-2">
                                                <Icon name="tabler:external-link" class="w-4 h-4" />
                                                <span>Live Demo</span>
                                            </a>
                                        )}
                                        {projectMetadata.githubLink && (
                                            <a href={projectMetadata.githubLink} target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-secondary-600 hover:text-secondary-900 dark:text-secondary-400 dark:hover:text-secondary-100 flex items-center gap-2">
                                                <Icon name="tabler:brand-github" class="w-4 h-4" />
                                                <span>GitHub</span>
                                            </a>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    <!-- TOC -->
                    {(tableOfContents || headings.length > 0) && (
                        <div>
                            <ul class="space-y-3 text-sm font-sans">
                                {tableOfContents 
                                    ? tableOfContents.split('\n').map((item) => {
                                        const link = item.trim().replace(/^-\s*/, '');
                                        const anchor = link.toLowerCase().replace(/\s+/g, '-');
                                        return (
                                            <li>
                                                <a href={`#${anchor}`} class="block text-secondary-500 dark:text-secondary-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                                                    {link}
                                                </a>
                                            </li>
                                        );
                                    })
                                    : headings.map((heading) => {
                                        const anchor = heading.toLowerCase().replace(/\s+/g, '-');
                                        return (
                                            <li>
                                                <a href={`#${anchor}`} class="block text-secondary-500 dark:text-secondary-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
                                                    {heading}
                                                </a>
                                            </li>
                                        );
                                    })}
                            </ul>
                        </div>
                    )}
                </div>
            </div>

            <!-- Content Column -->
            <div class="lg:col-span-7 lg:col-start-4">
                <div class="prose dark:prose-invert max-w-none 
                    prose-headings:font-semibold prose-headings:tracking-tight prose-headings:text-text dark:prose-headings:text-cream
                    prose-p:text-secondary-600 dark:prose-p:text-secondary-300 prose-p:leading-relaxed
                    prose-a:font-bold prose-a:underline prose-a:text-text dark:prose-a:text-white hover:prose-a:text-primary-600 dark:hover:prose-a:text-primary-400
                    prose-img:rounded-3xl font-body">
                    <Content />
                </div>
            </div>
        </div>
    </article>
</Layout>

<script>
    // Only load the webcomponent in the browser
    if (typeof window !== 'undefined') {
        import('jdls-boids-canvas').catch(err => {
            console.warn('Failed to load boids webcomponent:', err);
        });
    }
</script>
